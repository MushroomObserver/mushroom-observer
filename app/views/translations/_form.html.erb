<%= form_with(url: { action: :update, for_page: @for_page },
              id: "translation_form", method: :patch, local: false) do |f| %>

  <%= f.hidden_field(:tag, value: @tag) %>

  <%# "Official" text at top %>
  <% unless @lang.official
    concat(tag.h4("#{Language.official.name}:", class: "font-weight-bold"))

    @edit_tags.each do |ttag|
      if record = @official_records[ttag]
        concat(tag.span("#{h(ttag)}:", class: "underline"))
        concat(tag.p do
          str = record.text.gsub(/\\n/, "\n")
          h(str).gsub("\n", "<br/>\n")
        end)
      end
    end

    concat(tag.hr(class: "pb-1 pt-3"))
  end %>

  <%# Form for this language's translations %>
  <%= tag.h4("#{@lang.name}:", class:"font-weight-bold mt-2") %>

  <%# textarea for each tag %>
  <% @edit_tags.each do |ttag|

    # Estimate number of rows needed for text area.
    str = @strings[ttag].to_s.gsub(/\\n/, "\n")
    rows = 1
    str.each_line.each do |line|
      rows += (line.length / 80).truncate + 1
    end
    rows = @edit_tags.length > 1 ? 2 : 5 if rows < 2

    # Add help notes for plurals and uppercase entries.
    notes = []
    if ttag.match(/s$/i) && @edit_tags.include?(ttag.sub(/.$/,""))
      notes << :edit_translations_plural.t
    elsif (@edit_tags & [ttag+"s", ttag+"S"]).any? # like multi-include?
      notes << :edit_translations_singular.t
    end
    if ttag == ttag.upcase && @edit_tags.include?(ttag.downcase)
      notes << :edit_translations_uppercase.t
    elsif ttag == ttag.downcase && @edit_tags.include?(ttag.upcase)
      notes << :edit_translations_lowercase.t
    end

    between = notes.any? ? tag.span("(#{notes.safe_join(", ")})") : ""

    concat(text_area_with_label(form: f, field: "tag_#{ttag}", label: ttag,
                                between: between, value: str, rows: rows))

  end %>

  <%# save/cancel/reload buttons %>
  <%= tag.div(class: "form-group") do
    [
      button_tag(:SAVE.l, type: :submit, name: :commit, value: :submit,
                 id: "save_button", class: "btn btn-default"),
      button_tag(:CANCEL.l, type: :button, name: :commit, value: :cancel,
                 id: "cancel_button", class: "btn btn-default"),
      link_to(:RELOAD.l,
              edit_translation_path(id: @tag, locale: @lang.locale),
              id: "reload_button", # type: :button,
              class: "btn btn-default", remote: true, data: { tag: @tag })
    ].safe_join(" ")
  end %>

  <%# locale select. JS changes the reload link above, based on selected %>
  <%= select_tag(:locale,
                 options_for_select(Language.menu_options, @lang.locale),
                 class: "form-control", data: { tag: @tag }) %>

  <%# Past versions of translations %>
  <%
    done_header = false
    user_logins = { @user.id => @user.login }

    @edit_tags.each do |ttag|
      if record = @translated_records[ttag]
        user_logins[record.user_id] ||= record.user.login rescue nil
        last_text = record.text
        versions_to_show = []
        record.versions.reverse.each do |version|
          if version.text != last_text
            versions_to_show << version
            last_text = version.text
          end
        end

        if versions_to_show.any?
          if !done_header
            concat(tag.hr(class: "pb-1 pt-3"))
            concat(tag.h4("#{:edit_translations_old_versions.t}:",
                          class: "pb-2 font-weight-bold"))
            done_header = true
          end

          concat(tag.span("#{h(ttag)}:", class: "underline"))
          concat(tag.br)
          concat(tag.table(class: "table-striped old_versions pb-1") do
            versions_to_show.each do |version|
              concat(tag.tr do
                [
                  tag.td do
                    user_id = version.user_id
                    login = user_logins[user_id] ||=
                      User.find(user_id).login rescue ""
                    login.blank? ? "--" : user_link(user_id, login)
                  end,
                  tag.td(version.updated_at.web_date),
                  tag.td do
                    concat(h(str = preview_string(version.text, 80)))
                    if str.length > 80
                      concat(
                        link_to("[#{:edit_translations_full_text.t}]",
                                translation_versions_path(id: version.id),
                                remote: true,
                                data: { role: "show_versions", id: version.id })
                      )
                    end
                  end
                ].safe_join
              end)
            end
          end)
        end
      end
    end
  %>

<% end %>
