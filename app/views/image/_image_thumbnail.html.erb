<%
# IMPORTANT: Sometimes it's prohibitive to do the extra join to images table,
# so we only have image_id.  It's still possible to render the image with
# nothing but the image_id.  (But not votes, original name, etc.)
image, image_id = image.is_a?(Image) ? [image, image.id] : [nil, image]
size_url   = Image.url(size, image_id)
medium_url = Image.url(:medium, image_id)
large_url  = Image.url(:large, image_id)
huge_url   = Image.url(:huge, image_id)
full_url   = Image.url(:full_size, image_id)
orig_url   = Image.url(:original, image_id)
  #If the image is part of an image set.
is_set = is_set || false

# Image attributes
img_class = if responsive
              "max-w-100 h-auto m-auto #{img_class}"
            else
              "img-unresponsive #{img_class}"
            end
img_tag = image_tag(size_url, title: notes,
                    class: img_class,
                    data: { toggle: "tooltip", placement: "bottom" })

# Lightbox links
lightbox_id = is_set ? "observation-set" : SecureRandom.uuid

# Should we show the filename?
show_filename = original && image && !image.original_name.blank? &&
                (check_permission(image) ||
                image.user && image.user.keep_filenames == :keep_and_show)
%>

<div class="image-sizer position-relative w-100">

  <%= tag.div class: "image-lazy-sizer overflow-hidden",
              style: "padding-bottom: #{img_proportion}%;" do
    image_tag("placeholder.svg", html_options) # was thumb_url
  end %>

  <%= link_to "", link, class: "stretched-link" %>

  <%=
    show_orig = "<a href='' target='_blank' class='text-light lightbox_link'>#{:image_show_original.t}</a>"
    show_exif = "<a href='javascript:popup_exif(#{image_id})' class='text-light lightbox_link'>#{:image_show_exif.t}</a>"
    caption = "#{show_orig} | #{show_exif}".html_safe
    icon = "<i class='glyphicon glyphicon-fullscreen'></i>".html_safe
    link_to(icon,
            large_url,
            class: "theater-btn",
            data: {
              lightbox: lightbox_id,
              title: caption
            })
  %>

  <% if User.current && votes && image %>
    <div class="vote-section">
      <%= render(partial: "image/image_vote_links",
                 locals: { image: image }) %>
    </div><!-- .vote-section -->
  <% end %>

</div>

<% if show_filename %>
  <div class="text-center">
    <span><%= image.original_name %></span>
  </div><!-- .text-center -->
<% end %>
