<%= tag.div(class: "panel panel-default",
            id: "observation_links_panel") do

  [
    tag.div(class: "panel-heading") do
      tag.h4(:EXTERNAL_LINKS.t, class: "panel-title")
    end,

    tag.turbo_frame(
      id: "observation_external_links", class: "panel-body",
      data: { controller: "section-update",
              updated_by: "modal_external_link" }
    ) do

      if obs.external_links.any?
        [
          tag.ul(class: "tight-list") do
            obs.external_links.sort_by(&:site_name).each do |link|
              tag.li(id: "external_link_#{link.id}") do
                concat(link_to(link.external_site.name, link.url))
                if link.can_edit? || in_admin_mode?
                  concat(
                    [
                      " [",
                      modal_link_to("external_link",
                                    *edit_external_link_tab(link: link)),
                      "|",
                      destroy_button(
                        name: :destroy_object.t(type: :external_link),
                        target: external_link_path(id: link.id),
                        data: {
                          turbo: true,
                          confirm: :show_observation_remove_link_dialog.l
                        }, icon: :remove,
                        class: "destroy_external_link_link_#{link.id}"
                      )
                      "]"
                    ].safe_join(" ")
                  )
                end
              end
            end.safe_join
          end
        ].safe_join
      end
    end,

    tag.div(class: "panel-footer") do
      concat(@new_sites.sort_by(&:name).each do |site|
        [
          tag.span(site.name),
          [ # any html helper has to be safe_joined separately
            "[",
            modal_link_to("external_link",
                          *new_external_link_tab(obs: obs.id, site: site.id)),
            "]"
          ].safe_join
        ].safe_join(" ")
      end)
    end

  ].safe_join

end %>
