<%
logged_in = @user&.verified
any_names = observation.namings && observation.namings.length > 0

do_suggestions = logged_in && observation.thumb_image_id.present? &&
                  (@user.admin || MO.image_model_beta_testers.include?(@user.id))

namings = observation.namings.sort_by(&:created_at)

buttons = []
buttons << link_with_query(:show_namings_propose_new_name.t,
              new_observation_naming_path(observation_id: observation.id),
              { class: "btn btn-default" })
buttons << link_to(:show_namings_suggest_names.l, "#",
              { data: { role: "suggest_names" }, class: "btn btn-default" }) \
              if do_suggestions
help = logged_in ? :show_namings_consensus_help.t : :show_namings_please_login.t
eye  = "#{image_tag("eye3.png")} = #{:show_namings_eye_help.t}".html_safe
eyes = "#{image_tag("eyes3.png")} = #{:show_namings_eyes_help.t}".html_safe
%>

<div id="observation_namings">

  <!--TABLE OF NAMES -->
  <section class="table-namings">
    <header class="table-row">
      <div class="table-cell">
        <%= content_tag(:h4,
                        (any_names ? :show_namings_proposed_names.t :
                                     :show_namings_no_names_yet.t),
                        class: "table-title mb-0") %>
      </div>
      <div class="table-cell"><%= :show_namings_user.t %></div>
      <div class="table-cell"><%= :show_namings_consensus.t %></div>
      <div class="table-cell"><%= logged_in ? :show_namings_your_vote.t : "" %></div>
      <div class="table-cell"></div>
    </header>
    <% namings.each do |naming| %>
      <%= render(partial: "observations/namings/row",
                 locals: { naming: naming, observation: observation,
                           logged_in: logged_in }) %>
    <% end # each naming %>
  </section>
  <!--/TABLE OF NAMES -->

  <!--HELP TEXT AND EYES -->
  <div class="float-sm-right my-2 ml-3">
    <%= buttons.safe_join("<br/>".html_safe) %>
  </div>
  <div class="help-block container-text my-2"><%= help %></div>
  <div class="row">
    <div class="col-xs-6"><div class="p-2"><%= eye %></div></div>
    <div class="col-xs-6"><div class="p-2"><%= eyes %></div></div>
  </div>
  <!--/HELP TEXT AND EYES -->

</div><!--#observation_namings-->

<!--VOTE POPUPS-->
<% observation.namings.select {
    |naming| naming.votes.length > 0 }.each do |naming|
  @naming = naming %>
  <%= render(partial: "observations/namings/votes/popup",
              locals: { do_cancel: true, naming: @naming }) %>
<% end %>

<% inject_javascript_at_end %(
  VoteByAjaxModule({
    show_namings_lose_changes: '#{j :show_namings_lose_changes.l.gsub("\n", " ")}',
    show_namings_saving: '#{j :show_namings_saving.l}'
  })
) %>
<!--/VOTE POPUPS-->

<!--SUGGESTIONS-->
<%
@query ||= nil
url = naming_suggestions_for_observation_path(id: observation.id,
        names: :xxx, q: get_query_param(@query))

inject_javascript_at_end %(
  SuggestionModule(#{observation.image_ids}, "#{url}", {
    suggestions_processing_images:  "#{j :suggestions_processing_images.t}",
    suggestions_processing_image:   "#{j :suggestions_processing_image.t}",
    suggestions_processing_results: "#{j :suggestions_processing_results.t}",
    suggestions_error:              "#{j :suggestions_error.t}"
  });
) %>
<!--/SUGGESTIONS-->
