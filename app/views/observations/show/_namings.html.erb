<%
logged_in = @user&.verified
do_suggestions = logged_in && observation.thumb_image_id.present? &&
                  (@user.admin ||
                   MO.image_model_beta_testers.include?(@user.id))
namings = observation.namings.sort_by(&:created_at)
namings_with_votes = observation.namings.select { |naming|
                        naming.votes&.length&.positive? }
header = observation_naming_header_row(observation, logged_in)
buttons = observation_naming_buttons(observation, do_suggestions)
help = logged_in ? :show_namings_consensus_help.t : :show_namings_please_login.t
eye  = content_tag(:div,
         "#{image_tag("eye3.png")} = #{:show_namings_eye_help.t}".html_safe,
         class: "p-2")
eyes = content_tag(:div,
         "#{image_tag("eyes3.png")} = #{:show_namings_eyes_help.t}".html_safe,
         class: "p-2")
%>

<div id="observation_namings">

  <!--TABLE OF NAMES -->
  <div class="namings-table">
    <div class="container-fluid">
      <header class="row">
        <div class="col col-xs-12 col-sm-3"><%= header[:heading] %></div>
        <div class="col col-sm-3 hidden-xs"><%= header[:user_name] %></div>
        <div class="col col-sm-2 hidden-xs"><%= header[:consensus_vote] %></div>
        <div class="col col-sm-3 hidden-xs"><%= header[:your_vote] %></div>
        <div class="col col-sm-1 hidden-xs"></div>
      </header>
    </div>

    <div class="container-fluid panel panel-default">
      <% namings.each do |naming| %>
        <%= render(partial: "observations/namings/row",
                    locals: { naming: naming, observation: observation,
                              logged_in: logged_in }) %>
      <% end # each naming %>
    </div>
  </div>
  <!--/TABLE OF NAMES -->

  <!--HELP TEXT AND EYES -->
  <div class="float-sm-right my-2 ml-3"><%= buttons %></div>
  <div class="help-block container-text my-2"><%= help %></div>
  <div class="row hidden-xs">
    <div class="col-xs-6"><%= eye %></div>
    <div class="col-xs-6"><%= eyes %></div>
  </div>
  <!--/HELP TEXT AND EYES -->

</div><!--#observation_namings-->

<!--VOTE POPUPS-->
<% namings_with_votes.each do |naming|
  @naming = naming %>
  <%= render(partial: "observations/namings/votes/modal_community_votes",
             locals: { naming: @naming }) %>
<% end %>

<!--AJAX SAVING VOTE MESSAGE-->
<%= render(partial: "shared/modal_ajax_progress",
           locals: { naming: @naming }) %>

<% # initializes module with translations for js messages
inject_javascript_at_end %(
  VoteByAjaxModule({
    show_namings_lose_changes: '#{j :show_namings_lose_changes.l.gsub("\n", " ")}',
    show_namings_saving: '#{j :show_namings_saving.l}'
  })
) %>
<!--/VOTE POPUPS-->

<!--SUGGESTIONS-->
<%
@query ||= nil
url = naming_suggestions_for_observation_path(id: observation.id,
        names: :xxx, q: get_query_param(@query))

inject_javascript_at_end %(
  SuggestionModule(#{observation.image_ids}, "#{url}", {
    suggestions_processing_images:  "#{j :suggestions_processing_images.t}",
    suggestions_processing_image:   "#{j :suggestions_processing_image.t}",
    suggestions_processing_results: "#{j :suggestions_processing_results.t}",
    suggestions_error:              "#{j :suggestions_error.t}"
  });
) %>
<!--/SUGGESTIONS-->
