<%# bs4 filter for identify observations index %>
<%# Replaces the usual pattern_search form in the top nav %>

<%# TODO: make the form input have selects with autocomplete that send the ID %>
<%# Otherwise the records have to be looked up (several times) %>

<%
# Show the incoming `needs_id` query in the search bar if there has been one
filter_type = params.dig(:filter, :type) || false
selected = filter_type ? filter_type.to_sym : :clade
value = filter_type ? params.dig(:filter, :term) : ""
placeholder = "Filter by:"
filter_types = [
  [:CLADE.l, :clade],
  [:REGION.l, :region],
  # [:USER.l, :user],
]
%>

<%= form_with(url: identify_observations_path, method: :get,
              class: "form-inline", scope: :filter,
              id: "identify_filter") do |f| %>

  <%= content_tag(:div, class: "input-group") do
    concat(f.text_field(:term,
                        # turn off browser autocomplete
                        autocomplete: "off", value: value,
                        placeholder: placeholder,
                        class: "form-control", size: 42,
                        data: { autofocus: true }))
    concat(f.select(:type, filter_types, { selected: selected },
                    { class: "form-control",
                      onchange: "MOEvents.rebindAutoComplete(this.value);" }))
    concat(content_tag(:div, class: "input-group-append") do
              concat(f.submit(icon("fa-solid", "fa-magnifiying-glass",
                                   class: "btn btn-outline-primary"),
                                   aria: { label: :SEARCH.l }))
              concat(f.submit(icon("fa-solid", "fa-broom-wide",
                                   class: "btn btn-outline-primary"),
                                   aria: { label: :CLEAR.l }))
            end)
  end %>

  <% turn_into_clade_auto_completer(:filter_term) %>

  <% # initializes module with translations for js messages
  inject_javascript_at_end %(
    $("#filter_term").on("change", function() {
      MOEvents.rebindAutoComplete(this.value)
    })
  ) %>

<% end %>
