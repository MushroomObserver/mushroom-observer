<%
# Naming Row (widescreen):
# Shows a proposed naming for this observation, with a tiny vote form.
# Also naming edit and delete buttons if the current user owns the naming.
consensus = observation.consensus_naming

Textile.register_name(naming.name)
percent = naming.vote_percent.round.to_s.html_safe + "%"
any_votes = naming.votes && naming.votes.length > 0
can_vote = check_permission(naming)
@vote = @votes[naming.id]
show_votes_link = link_with_query(
                    h(percent), naming_vote_path(naming_id: naming.id),
                    { class: "vote-percent",
                      data: { role: "open_popup", id: naming.id } })
num_votes_span = content_tag(:span, naming.votes.length,
                             { class: "vote-number", data: { id: naming.id } })
reasons = naming.reasons_array.select(&:used?).map do |reason|
              reason.notes.blank? ? reason.label.t :
                "#{reason.label.l}: #{reason.notes.to_s.html_safe}".tl
            end
reasons = reasons.map do |reason|
            ("<div><span>#{reason}</span></div>").html_safe
            end

row = {
  show:   link_with_query(
              naming.display_name_brief_authors.t.break_name.small_author,
              show_name_path(id: naming.name)
            ),
  edit:    link_with_query(:EDIT.t, edit_naming_path(id: naming.id),
                           class: "edit_naming_link_#{naming.id}"),
  destroy: destroy_button(target: naming),
  user:    user_link(naming.user, naming.user.login),
  percent: (any_votes ?
              "#{show_votes_link} (#{num_votes_span})" :
              "(#{:show_namings_no_votes.t})").html_safe,
  eyes:    [(observation.owners_favorite?(naming) ? image_tag("eye3.png") : ""),
            (naming == consensus ? image_tag("eyes3.png") : "")].safe_join,
  reasons: reasons.safe_join
}
%>

<div class="table-row" id="observation_naming_<%= naming.id %>">
  <div class="table-cell">
    <%= row[:show] %>
    <% if can_vote %>
      <br />[<%= row[:edit] %> | <%= row[:destroy] %>]
    <% end %>
  </div>
  <div class="table-cell">
    <%= [content_tag(:small, "#{:show_namings_user.t}: ",
                     class: "visible-xs-inline mr-4" ),
         content_tag(:strong, row[:user])].safe_join %>
  </div>
  <div class="table-cell">
    <%= [content_tag(:small, "#{:show_namings_consensus.t}: ",
                     class: "visible-xs-inline mr-4" ),
         content_tag(:span, row[:percent])].safe_join %>
  </div>
  <div class="table-cell">
    <% if logged_in %>
      <%= content_tag(:small, "#{:show_namings_your_vote.t}: ",
                      class: "visible-xs-block" ) %>
      <%= render(partial: "observations/namings/votes/form",
                 locals: { naming: naming, can_vote: can_vote }) %>
    <% end %>
  </div>
  <div class="table-cell">
    <%= row[:eyes] %>
  </div>
</div>
<div class="table-row">
  <% # NOTE: fake CSS colspan here requires other table-cells below %>
  <div class="table-cell colspan">
    <%= row[:reasons] %>
  </div>
  <div class="table-cell"></div>
  <div class="table-cell"></div>
  <div class="table-cell"></div>
  <div class="table-cell"></div>
</div>
