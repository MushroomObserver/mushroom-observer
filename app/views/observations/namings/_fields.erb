<%
# This is included by obs form, naming new/edit form + lightbox identifier

# Prefer NamingParams, but use raw params if no params.
what = @params.what rescue @what
valid_names = @params.valid_names rescue @valid_names
suggest_corrections = @params.suggest_corrections rescue @suggested_corrections
parent_deprecated = @params.parent_deprecated rescue @parent_deprecated
reasons = @params.reasons rescue @reasons
names = @params.names rescue @names
vote = @params.vote rescue @vote

unfocused ||= false
focus_on_name = !unfocused && (button_name != :CREATE.l || what.empty?)
focus_on_vote = !unfocused && (button_name == :CREATE.l && what.present?)

feedback_locals = {
  f: f,
  button_name: button_name,
  what: what,
  valid_names: valid_names,
  suggest_corrections: suggest_corrections,
  parent_deprecated: parent_deprecated,
  names: names
}

confidences = options_for_select(Vote.confidence_menu, vote&.value)
select_opts = { include_blank: ["new", "create"].include?(action_name) }
context ||= "blank"
%>

<%=
[
  tag.div(class: "row") do
    tag.div(class: "col-xs-12 col-sm-6") do
      render(partial: "shared/form_name_feedback",
             locals: feedback_locals) if what.present?
    end
  end,
  fields_for(:naming) do |f_n|
    [
      tag.div(class: "row mt-3") do
        [
          tag.div(class: "col-xs-12 col-sm-6") do
            [
              text_field_with_label(form: f_n, field: :name, size: 40,
                                    label: :WHAT.t + ":",
                                    value: what, autocomplete: "off",
                                    data: { autofocus: focus_on_name }),
              turn_into_name_auto_completer(:naming_name, primer: Name.primer)
            ].safe_join
          end,
          tag.div(class: "col-xs-12 col-sm-6") do
            help_block_with_arrow("left", id: "naming_name_help") do
              tag.p(:form_naming_name_help.t)
            end
          end
        ].safe_join
      end,
      tag.div(class: "row mt-3") do
        tag.div(class: "col-xs-12 col-sm-6") do
          [
            f_n.fields_for(:vote) do |f_v|
              select_with_label(form: f_v, field: :value,
                                options: confidences,
                                select_opts: select_opts,
                                label: :form_naming_confidence.t + ":",
                                data: { autofocus: focus_on_vote })
            end,
            f_n.fields_for(:reasons) do |f_r|
              reasons.values.sort_by(&:order).each do |r|
                collapse = r.used? ? "" : "collapse"
                [
                  tag.div(class: "checkbox") do
                    f_r.label("#{r.num}_check",
                              { data: {
                                  toggle: "collapse",
                                  target: "#reasons_#{r.num}_notes"
                                },
                                aria: {
                                  expanded: "false",
                                  controls: "reasons_#{r.num}_notes"
                                } }) do
                      [
                        f_r.check_box(:check,
                                      { index: r.num,
                                        checked: r.used?,
                                        class: "" },
                                      "1"),
                        r.label.t
                      ].safe_join
                    end
                  end,
                  tag.div(id: "reasons_#{r.num}_notes",
                          class: class_names("form-group mb-3", collapse)) do
                    f_r.text_area(:notes,
                                  index: r.num, rows: 3, value: r.notes,
                                  class: "form-control")
                  end
                ].safe_join
              end.safe_join
            end
          ].safe_join
        end
      end
    ].safe_join
  end,
  hidden_field_tag(:context, context)
].safe_join
%>

<% inject_javascript_at_end %(
  jQuery(document).ready(function() {
    jQuery(document).on('shown.bs.collapse', '.collapse', function () {
      $(this).first('textarea').focus();
    });
  });
) %>
