<%
  # IMPORTANT: Sometimes it's prohibitive to do the extra join to images table,
  # so we only have image_id.  It's still possible to render the image with
  # nothing but the image_id.  (But not votes, original name, etc.)
  image, image_id = image.is_a?(Image) ? [image, image.id] : [nil, image]
  size_url   = Image.url(size, image_id)
  medium_url = Image.url(:medium, image_id)
  large_url  = Image.url(:large, image_id)
  huge_url   = Image.url(:huge, image_id)
  full_url   = Image.url(:full_size, image_id)
  # If the image is part of an image set.
  is_set = is_set || true

  # Lightbox stuff. obs_data comes from the matrix_box presenter,
  # link_type from view (for naming links)
  lightbox_id = is_set ? "observation-set" : SecureRandom.uuid
  p_map = {
    "medium" => medium_url,
    "large" => large_url,
    "huge" => huge_url,
    "full_size" => full_url
  }
  lightbox_url = (usize = User.current&.image_size) ? p_map[usize] : huge_url
  caption = image_caption_html(image_id, obs_data, link_type)

  # Show original name?
  show_original_name = original && image && !image.original_name.blank? &&
    (check_permission(image) || image.user && image.user.keep_filenames == "keep_and_show")

  # FIXME: Pass a srcset attribute, or symbol, from context for true responsive
  image_link = image_link_html(link, link_method)
%>

<div class="position-relative">
  <div class="d-inline">
    <div data-toggle="expand-icon" class="text-center">
      <div class="click-container position-relative">
        <%= image_tag(size_url, title: notes,
                      class: "img-fluid #{extra_classes}",
                      data: { toggle: "tooltip", placement: "bottom" }) %>
        <%= image_link %>
      </div>
      <%= link_to("", lightbox_url,
                  class: "glyphicon glyphicon-fullscreen theater-btn",
                  data: { lightbox: lightbox_id, title: caption }) %>
      <div class="mt-3">
        <% if User.current and votes and image %>
          <%= render(partial: "shared/image_vote_links",
                     locals: { image: image }) %>
        <% end %>
        <% if show_original_name %>
          <div class="text-center">
            <span><%= image.original_name %></span>
          </div><!-- .text-center -->
        <% end %>
      </div>
    </div>
  </div>
</div>
