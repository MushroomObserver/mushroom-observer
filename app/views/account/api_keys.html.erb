<%
  @title = :account_api_keys_title.t

  tabs = [
    link_to(:prefs_link.t,   action: :prefs),
    link_to(:profile_link.t, action: :profile)
  ]
  @tabsets = { right: draw_tab_set(tabs) }
  @container = :full

  javascript_include("api_key")
  inject_javascript_at_end("APIKeyModule()")
%>

<div class="container-text">
  <%= :account_api_keys_help.tp %>
</div><!--.container-text-->

<% if @user.api_keys.any? %>
  <%= form_with(url: { action: :api_keys }) do |form| %>

    <table class="table table-striped py-5px">
      <tr>
        <th></th>
        <th><%= :CREATED.t %></th>
        <th><%= :account_api_keys_last_used_column_label.t %></th>
        <th><%= :account_api_keys_num_uses_column_label.t %></th>
        <th><%= :API_KEY.t %></th>
        <th><%= :NOTES.t %></th>
      </tr>

      <% @user.api_keys.sort_by do |key|
        last_use = Time.zone.now - key.last_used rescue 0
        [-key.num_uses, last_use, key.id]
      end.each do |key| %>

        <tr>
          <td><%= form.check_box("key_#{key.id}") %></td>
          <td><%= key.created_at.web_date %></td>
          <td id="key_time_<%= key.id %>">
            <%= if key.verified
              key.last_used ? key.last_used.web_date : '--'
            else
              link_to("[:ACTIVATE.t}]",
                      { action: :activate_api_key, id: key.id },
                      data: { role: "activate_api_key", id: key.id })
            end %>
          </td>
          <td><%= key.num_uses > 0 ? key.num_uses : '--' %></td>
          <td><%= h(key.key) %></td>
          <td id="key_notes_<%= key.id %>">
            <div class="edit_key_notes_container"
                 data-target-key="<%= key.id %>" style="display:none">
              <%= form.text_field("key_notes_#{key.id}",
                                  { value: key.notes,
                                    data: { role: "key_notes_input",
                                            id: key.id } }) %>
              <%= button_tag(:SAVE.l, type: "button", class: "btn btn-default",
                             data: { role: "key_notes_save", id: key.id }) %>
              <%= button_tag(:CANCEL.l, type: "button",
                             class: "btn btn-default",
                             data: { role: "key_notes_cancel", id: key.id }) %>
            </div>
            <div class="view_key_notes_container"
                 data-target-key="<%= key.id %>">
              <span class="current_notes"><%= key.notes.t %></span>
              <%= link_to(:EDIT.t, { action: :edit_api_key, id: key.id },
                          data: { role: "edit_api_key", id: key.id }) %>
            </div>
          </td>
        </tr>
      <% end %>

    </table>

    <%= form.submit(:account_api_keys_remove_button.l,
                    { id: "remove_button",
                      class: "btn btn-default center-block" }) %>

  <% end %>
<% end %>

<div class="container-text mt-3">
  <%= form_with(scope: :key, url: { action: :api_keys }) do |f| %>

    <div class="form-group mt-3">
      <%= f.label(:notes, :account_api_keys_notes_label.t) %>
      <%= f.text_field(:notes, class: "form-control") %>
    </div>

    <%= f.submit(:account_api_keys_create_button.l, id: "create_button",
                 class: "btn btn-default center-block mt-3") %>

  <% end %>
</div>
