<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
  <%= auto_discovery_link_tag(:rss, {:controller => 'observer', :action => 'rss'}, {:title => :app_rss.l}) %>
  <title><%= :app_title.l %>: <%= @title.nil? ? controller.action_name : @title.strip_html.html_safe %></title>
  <link rel="SHORTCUT ICON" href="http://mushroomobserver.org/favicon.ico"/>
  <% if @canonical_link %>
      <link rel="canonical" href="<%= escape_once(@canonical_link) %>"/>
  <% end %>
  <%= csrf_meta_tag %>
  <meta property="og:image" content="http://mushroomobserver.org/images/facebook_icon.png"/>
  <meta property="og:title" content="Mushroom Observer"/>
  <meta property="og:description" content="Mushroom Observer is a forum where amateur and professional mycologists can come together and celebrate their common passion for mushrooms by discussing and sharing photos of mushroom sightings from around the world."/>
  <%= javascript_include_tag("jstz.min") %>
  <%= javascript_tag('try { document.cookie = "tz=" + jstz.determine().name() } catch(err) {}') %>
  <%= javascript_tag('var CSRF_TOKEN = "' + form_authenticity_token + '";') %>

  <%=
      css = MO.default_theme
      if is_in_admin_mode?
        css = 'Admin'
      elsif browser.bot?
        css = MO.default_theme
      else
        if MO.themes.member?(controller.action_name) ##what does this do?
          css = controller.action_name
        else
          if !@user.nil?
            css = @user.theme
          end
        end
        unless MO.themes.member?(css)
          css = MO.themes.sample
        end
      end
      stylesheet_link_tag("bootstrap") +
              stylesheet_link_tag("custom")
  %>
  <% if @header %>
      <%= @header %>
  <% end %>
</head>
<body>
<div class="container">
  <!-- <div class="row">
    <div class="col-xs-12">
      <% if is_in_admin_mode? %>
          <div class="text-danger">DANGER: You are in administrator mode. Proceed with caution.</div>
      <% end %>
      <%
   banner = :app_banner_box.t
   if banner.to_s.length > 1 %>
          <div id="message_banner" class="center-text">
            <%= banner %>
          </div>
      <% end %>
    </div>
  </div>-->
  <div class="row">
    <div id="navigation" class="col-md-2 color1">
      <div id="banner">
        <%= link_to(:app_banner.t, browser.bot? ? "/sitemap/index.html" : "/") %>
      </div>
      <div class="group">
        <%= link_to(:app_intro.t, :controller => 'observer', :action => 'intro') %>
        <%= link_to(:app_how_to_use.t, :controller => 'observer', :action => 'how_to_use') %>
        <%= link_to(:app_how_to_help.t, :controller => 'observer', :action => 'how_to_help') %>
        <%= link_to(:app_donate.t, :controller => 'support', :action => 'donate') %>
        <%= link_to(:app_feature_tracker.t, :controller => 'pivotal', :action => 'index') %>
        <%= link_to(:app_send_a_comment.t, :controller => 'observer', :action => 'ask_webmaster_question') %>
      </div>
      <div class="group">
        <%= link_to(:app_index_a_z.t, :controller => 'name', :action => 'observation_index') %>
        <%= link_to(:app_list_locations.t, :controller => 'location', :action => 'list_locations') %>
        <%= link_to(:app_list_projects.t, :controller => 'project', :action => 'list_projects') %>
      </div>
      <div class="group">
        <%= :app_latest.t %>:
        <div class="pad-left">
          <%= link_to(:app_latest_changes.t, {:controller => 'observer', :action => 'list_rss_logs'}, data: {confirm: 'yes'}) %>
          <%= link_to(:app_newest_images.t, :controller => 'image', :action => 'list_images') %>
          <%= link_to(:app_comments.t, :controller => 'comment', :action => 'list_comments') %>
          <%= link_to(:app_news.t, :controller => 'observer', :action => 'news') %>
        </div>
      </div>
      <div class="group">
        <%= :app_observations_left.t %>:
        <div class="pad-left">
          <%= link_to(:app_create_observation.t, :controller => 'observer', :action => 'create_observation') %>
          <%= link_to(:app_sort_by_date_obs.t, :controller => 'observer', :action => 'list_observations') %>
        </div>
      </div>
      <div class="group">
        <%= :app_species_list.t %>:
        <div class="pad-left">
          <%= link_to(:app_create_list.t, :controller => 'species_list', :action => 'name_lister') %>
          <%= link_to(:app_sort_by_date_spl.t, :controller => 'species_list', :action => 'list_species_lists') %>
          <%= link_to(:app_sort_by_title.t, :controller => 'species_list', :action => 'species_lists_by_title') %>
        </div>
      </div>
      <% if @user.nil? %>
          <div class="group">
            <%= :app_account.t %>:
            <div class="pad-left">
              <%= link_to(:app_login.t, :controller => 'account', :action => 'login') %>
              <%= link_to(:app_create_account.t, :controller => 'account', :action => 'signup') %>
            </div>
          </div>
      <% else %>
          <div class="group">
            <%= :app_current_user.t %>:
            <div class="pad-left">
              <%= h(@user.login) %>
              <%= link_to(:app_comments_for_you.t, :controller => 'comment', :action => 'show_comments_for_user', :id => @user.id) %>
              <%= link_to(:app_your_observations.t, :controller => 'observer', :action => 'observations_by_user', :id => @user.id) %>
              <%= link_to(:app_your_interests.t, :controller => 'interest', :action => 'list_interests') %>
              <%= link_to(:app_your_summary.t, :controller => 'observer', :action => 'show_user', :id => @user.id) %>
              <%= link_to(:app_preferences.t, :controller => 'account', :action => 'prefs') %><br/>
              <%= link_to(:app_join_mailing_list.t, 'https://groups.google.com/forum/?fromgroups=#!forum/mo-general') %>
              <%= link_to(:app_logout.t, :controller => 'account', :action => 'logout_user') %><br/>
            </div>
          </div>
          <% if @user.admin %>
              <div class="group">
                <%= :app_admin.t %>:
                <% if is_in_admin_mode? %>
                    <div class="pad-left">
                      <%= link_to(:app_users.t, {:controller => 'observer', :action => 'users_by_name'}) %>
                      <%= link_to(:change_banner_title.t, :controller => 'observer', :action => 'change_banner') %>
                      <%= link_to(:app_email_all_users.t, :controller => 'observer', :action => 'email_features') %>
                      <%= link_to(:app_add_to_group.t, :controller => 'account', :action => 'add_user_to_group') %>
                      <%= link_to(:account_manager_title.t, :controller => 'account', :action => 'manager') %>
                      <%= link_to(:app_turn_admin_off.t, :controller => 'account', :action => 'turn_admin_off') %>
                    </div>
                <% else %>
                    <div class="pad-left">
                      <%= link_to(:app_turn_admin_on.t, :controller => 'account', :action => 'turn_admin_on') %>
                    </div>
                <% end %>
              </div>
          <% end %>
      <% end %>
      <% unless browser.bot? %>
          <div class="group">
            <%= :app_languages.t %>:
            <div class="pad-left">
              <% for lang in Language.all.reject(&:beta).sort_by(&:order) %>
                  <%= link_to(h(lang.name), reload_with_args(:user_locale => lang.locale)) %>
              <% end %>
            </div>
          </div>
      <% end %>

      <% if DEVELOPMENT || is_reviewer?
           layouts = []
           for file in Dir.glob("#{::Rails.root.to_s}/app/views/layouts/*.html.erb")
             layouts << $1 if file.match(/(app\w+)\.html\.erb/)
           end
           if layouts.length > 1 %>
              <div class="group">
                Layouts:
                <div class="pad-left">
                  <% for layout in layouts.sort
                       layout2 = layout == 'application' ? 'old' : layout %>
                      <%= link_to(layout2, h(reload_with_args(:user_theme => layout))) %>
                  <% end %>
                </div>
              </div>
          <% end %>
      <% end %>

      <div class="group">
        <%= link_to(:app_glossary.t, :controller => 'glossary', :action => 'index') %>
        <%= link_to(:app_publications.t, :controller => 'publications', :action => 'index') %>
        <%= link_to(:app_contributors.t, :controller => 'observer', :action => 'users_by_contribution') %>
        <%= link_to(:app_site_stats.t, :controller => 'observer', :action => 'show_site_stats') %>
        <%= link_to(:translators_note_title.t, :controller => 'observer', :action => 'translators_note') %>
      </div>
      <div class="group hidden-xs">
        <%= link_to(:app_colors_from.t(:theme => css.to_sym.l), :controller => 'observer', :action => 'color_themes') %>
        <%= :app_powered_by.t %>:
        <a href='http://www.rubyonrails.org'>Ruby&nbsp;on&nbsp;Rails</a>
        <%= :app_preferred_browser.t %>:
        <a href='http://www.mozilla.com/firefox/'>FireFox</a>
        <% if @invalid.nil? %>
            <p>
              <a href="http://validator.w3.org/check?uri=referer"><img
              src="http://www.w3.org/Icons/valid-xhtml10"
              alt="Valid XHTML 1.0 Transitional" height="31" width="88" border="0"/></a>
            </p>
        <% end %>
      </div>
    </div>
    <!--END NAVIGATION -->

    <div class="col-md-10"> <!--SEARCH BAR-->
      <div id="search_bar_row" class="row">
        <div class="col-sm-12">
          <div id="search_bar" class="pad-top">
            <%= form_tag(:controller => 'observer', :action => 'pattern_search') do %>
                <b><%= :app_find.t %></b>:&nbsp;
                <%= text_field(:search, :pattern, :size => 30,
                               :value => session[:pattern]) %>
                <%= options = [
                        [:COMMENTS.l, :comment],
                        [:HERBARIA.l, :herbarium],
                        [:IMAGES.l, :image],
                        [:LOCATIONS.l, :location],
                        [:NAMES.l, :name],
                        [:OBSERVATIONS.l, :observation],
                        [:PROJECTS.l, :project],
                        [:SPECIES_LISTS.l, :species_list],
                        [:SPECIMENS.l, :specimen],
                        [:USERS.l, :user],
                        [:app_search_google.l, :google],
                ].sort
                    select(:search, :type, options,
                           :selected => session[:search_type] || :observation) %>
                <%= submit_tag :app_search.l %>
                <%= link_to(:app_advanced_search.l.nowrap, :controller => 'observer',
                            :action => 'advanced_search_form') %>
                <% if @timer_start %>
                    <span id="timer">
                      <%= @timer_end ||= Time.now
                          secs = '%.2f' % (@timer_end.to_f - @timer_start.to_f)
                          @timer_start = nil
                          "(#{:app_index_timer.t(:seconds => secs, :num => @num_results.to_i)})"
                          #'(' + :app_timer.t(:seconds => secs) + ')' TODO: why was this here?
                      %>
                    </span>
                <% end %>
            <% end %>
          </div>
        </div>
        <div class="col-xs-12">
          <div id="flashes">
            <% if flash_notices? %>
                <%= boxify(flash_notice_level) do %>
                    <%= begin
                          flash_get_notices # .to_s.encode('utf-8')
                        rescue
                          flash_get_notices # .to_s.force_encoding('utf-8')
                        end %>
                <% end %>
            <% end
               flash_clear %>
          </div>
        </div>
      </div>
      <!--END SEARCH BAR-->

      <div id="content" class="row">
        <div class="col-xs-12" id="Title">
          <h3 class="text-center">
            <%= @title %>
          </h3>
        </div>
        <div id="right_tabs" class="col-sm-12">
          <%= @right_tabs ? @right_tabs.safe_join(safe_br) : '' %>
        </div>
        <div id="left_tabs" class="col-sm-12">
          <div class="border-bottom margin-bottom pad-bottom">
            <%= render_tab_sets %>
          </div>
        </div>
        <div class="col-sm-12">
          <div class="TextContent"> <!--main content -->
            <%= yield %>
          </div>
        </div>

        <% lang = Language.find_by_locale(I18n.locale)
           if lang and (!lang.official or Language.tracking_usage) %>
            <div id="translators_credit" class="col-xs-12">
              <% if !lang.official %>
                  <%= :app_translators_credit.t %>:
                  <%= ids_and_names = lang.top_contributors(5)
                      user_links = ids_and_names.map do |id, name|
                        user_link(id, name)
                      end.safe_join(', ')
                      if ids_and_names.length == 5
                        user_links += ', ' + :app_translators_credit_and_others.t
                      end
                      user_links %><br/>
              <% end %>
              <% if Language.tracking_usage
                   file = Language.save_tags %>
                  <%= link_to(:app_edit_translations_on_page.t, :controller => :translation,
                              :action => :edit_translations, :page => file) %> |
                  <%= link_to(:app_edit_translations.t, :controller => :translation,
                              :action => :edit_translations) %>
              <% end %>
            </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!--Javascript should be last thing loaded -->
<%= javascript_include_tag("jstz.min") %>
<%= javascript_tag('try { document.cookie = "tz=" + jstz.determine().name() } catch(err) {}') %>
<% javascript_include('jquery')
   javascript_include('image_vote')
   javascript_include('bootstrap')
   javascript_include 'jquery'
   javascript_include 'jquery_extensions'
   javascript_include 'vote_popup' %>
<%= sort_javascript_includes.map { |m| javascript_include_tag(m) }.safe_join('') %>
<% ##a place to inject scripts into the page after the javascript elements have loaded %>
<%= @scripts %>
<script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o), m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })
    (window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'UA-1916187-1', 'auto');
    ga('send', 'pageview');
</script>
<script>
    jQuery(document).ready(function () {
        jQuery('body').on('click', '[data-confirm]', function (event) {
            return confirm($(this).data().confirm);
        })
    });
</script>
</body>
</html>
