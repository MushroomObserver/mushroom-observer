<% @location.force_valid_lat_lngs! %>
<% map_args = { editable: true, map_type: "location" } %>

<%= form_with(model: @location, url: action, id: "location_form") do |f| %>

  <% if !@location.locked || in_admin_mode? %>

    <%= render(partial: "shared/form_location_feedback",
               locals: { button: button.l} ) %>

    <%# NOTE: All other Stimulus data is on the map div, but we need
    the fields inside the controller scope, so map has controller: nil %>
    <%= tag.div(class: "row", data: { controller: "map" }) do %>
      <%= tag.div(class: "col-md-8 col-lg-6") do %>
        <%= render(partial: "locations/form/fields",
                   locals: { f:, button:, location: @location,
                   display_name: @display_name }) %>
      <% end %>

      <%= tag.div(class: "col-md-4 col-lg-6 mb-3 mt-3") do
        make_map(objects: [@location], **map_args.merge({ controller: nil }))
      end %><!--.col-md-4 col-lg-6-->
    <% end %><!--.row-->

  <% else %>

    <%= render(partial: "locations/form/show_locked", locals: { f: f }) %>

  <% end %>

  <%= tag.div(class: "container-text mt-3") do %>
    <%= text_area_with_label(
          form: f, field: :notes, label: :NOTES.t + ":",
          between: help_block(:div, :form_locations_notes_help.t)
        ) %>
    <%= render(partial: "shared/textilize_help") %>
  <% end %>

<% end %>
