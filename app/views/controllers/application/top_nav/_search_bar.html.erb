<%# locals: (search_help_types: [], search_form_types: []) %>

<%
# Temporary 2025-08-14: safe-pluralize the type (will not double-pluralize)
# When removing just revert to `session[:search_type]`
default = session[:search_type]&.to_s&.pluralize&.to_sym || :observations
help_controller = search_help_types.include?(default) ? default : nil
form_controller = search_form_types.include?(default) ? default : nil
search_options = options_for_select(search_type_options, default)
form_group_class = class_names(
  %w[form-group has-feedback has-search d-flex flex-grow-1 mb-0]
)
helpToggle_classes = formToggle_classes = %w[btn btn-link navbar-link px-2]
helpToggle_classes << "d-none" unless help_controller
formToggle_classes << "d-none" unless form_controller
# Fields have attributes nested under search via fields_for, eg search[:type]
%>

<% if @user %>
  <%= tag.div(class: "w-100", id: "search_nav_elements") do %>

    <%= tag.div(class: "collapse in w-100", id: "search_bar_elements",
                data: {
                  search_type_target: "bar",
                  action: "$shown.bs.collapse->search-type#closeForm"
                }) do %>

      <%= tag.div(class: "navbar-flex w-100 gap-2") do %>

        <%= tag.button(
          link_icon(:info, title: :search_bar_help.t),
          class: class_names(helpToggle_classes),
          type: :button,
          data: { toggle: "collapse", search_type_target: "helpToggle",
                  target: "#search_bar_help" },
          aria: { expanded: "false", controls: "search_bar_help" }
        ) if help_controller %>

        <%= form_with(url: search_pattern_path, method: :get,
                      class: "navbar-flex flex-grow-1 navbar-form px-0 gap-2",
                      id: "pattern_search_form") do |f| %>

          <%= fields_for(:pattern_search) do |f_s| %>
            <%= tag.div(class: form_group_class) do %>
              <%= link_icon(:search,
                            class: "form-control-feedback hidden-xs") %>
              <%= f_s.text_field(
                    :pattern,
                    value: session[:pattern],
                    class: "form-control flex-grow-1",
                    placeholder: :app_find.t
                  ) %>
            <% end %><!--.form-group-->

            <%= tag.div(class: "form-group text-nowrap mb-0") do %>
              <%= f_s.select(
                    :type, search_options, { },
                    { class: "form-control",
                      data: {
                        search_type_target: "select",
                        action: "search-type#getHelp search-type#getForm"
                      } }
                  ) %>
            <% end %><!--.form-group-->
          <% end %>

          <%= tag.div(class: "form-group text-nowrap") do %>
            <%= tag.button(type: :submit,
                          class: "btn btn-outline-default px-2") do
              [
                tag.span(link_icon(:search), class: "d-sm-none"),
                tag.span(:app_search.l, class: "hidden-xs")
              ].safe_join
            end %>
          <% end %><!--.form-group-->

        <% end %>

        <%= tag.button(
          link_icon(:plus, title: :OPTIONS.l),
          class: class_names(formToggle_classes),
          type: :button,
          data: { toggle: "collapse", search_type_target: "formToggle",
                  target: "#search_nav_form" },
          aria: { expanded: "false", controls: "search_nav_form" }
        ) %>

      <% end %>

      <%= tag.div(class: "collapse w-100", id: "search_bar_help",
                  data: { search_type_target: "help" }) do
        render(partial: "#{help_controller}/search/help") if help_controller
      end %>

    <% end %>

    <%= tag.div(class: "collapse w-100", id: "search_nav_form",
                data: {
                  search_type_target: "form",
                  action: "$shown.bs.collapse->search-type#closeBar"
                }) do
      # render(partial: "shared/search_form",
      #        locals: { local: false,
      #                  search: find_or_create_query(query_model),
      #                  field_columns: }) if form_controller
    end %>

  <% end %>

<% else %>
  <%= tag.strong(:app_login_reminder.t,
                 class: "navbar-text mx-2 text-nowrap") %>
<% end %>
