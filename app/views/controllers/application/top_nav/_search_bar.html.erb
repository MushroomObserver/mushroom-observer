<%
options = [
  [:COMMENTS.l, :comments],
  [:GLOSSARY.l, :glossary_terms],
  [:HERBARIA.l, :herbaria],
  # Temporarily disabled for performance reasons. 2021-09-12 JDC
  # [:IMAGES.l, :images],
  [:LOCATIONS.l, :locations],
  [:NAMES.l, :names],
  [:OBSERVATIONS.l, :observations],
  [:PROJECTS.l, :projects],
  [:SPECIES_LISTS.l, :species_lists],
  [:HERBARIUM_RECORDS.l, :herbarium_records],
  [:USERS.l, :users],
  [:app_search_google.l, :google],
].sort
# Temporary 2025-08-14: safe-pluralize the type (will not double-pluralize)
# When removing just revert to `session[:search_type]`
default = session[:search_type]&.to_s&.pluralize&.to_sym
search_options = options_for_select(options, default || :observations)
identify_page = controller.controller_name == "identify"
icon_class = class_names(%w[btn navbar-link px-0])
form_group_class = class_names(
  %w[form-group has-feedback has-search d-flex flex-grow-1 mb-0]
)
adv_search = icon_link_to(:app_advanced_search.l, search_advanced_path,
                          icon: :plus, class: icon_class, show_text: false)
# Fields have attributes nested under search via fields_for, eg search[:type]
%>

<% if @user %>
  <%= tag.div(class: "navbar-flex w-100 gap-2") do %>

    <%= icon_link_to(:search_bar_help.t, info_search_bar_help_path,
                     icon: :info, class: icon_class, show_text: false) %>

    <%= form_with(url: search_pattern_path, method: :get,
                  class: "navbar-flex flex-grow-1 navbar-form px-0 gap-2",
                  id: "pattern_search_form") do |f| %>

      <%= fields_for(:pattern_search) do |f_s| %>
        <%= tag.div(class: form_group_class) do %>
          <%= link_icon(:search, class: "form-control-feedback hidden-xs") %>
          <%= f_s.text_field(
                :pattern,
                value: session[:pattern],
                class: "form-control flex-grow-1",
                placeholder: :app_find.t
              ) %>
        <% end %><!--.form-group-->

        <%= tag.div(class: "form-group text-nowrap mb-0") do %>
          <%= f_s.select(
                :type, search_options, { }, { class: "form-control" }
              ) %>
        <% end %><!--.form-group-->
      <% end %>

      <%= hidden_field_tag(:needs_naming, true) if identify_page %>

      <%= tag.div(class: "form-group text-nowrap") do %>
        <%= tag.button(type: :submit,
                       class: "btn btn-outline-default px-2") do
          [
            tag.span(link_icon(:search), class: "d-sm-none"),
            tag.span(:app_search.l, class: "hidden-xs")
          ].safe_join
        end %>
      <% end %><!--.form-group-->

    <% end %>

    <%= icon_link_to(:app_advanced_search.l, search_advanced_path,
                     icon: :plus, class: icon_class, show_text: false) %>

  <% end %>

<% else %>

  <strong class="navbar-text mx-2 text-nowrap">
    <%= :app_login_reminder.t %>:
  </strong>

<% end %>
