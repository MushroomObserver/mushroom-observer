<%
# Temporary 2025-08-14: safe-pluralize the type (will not double-pluralize)
# When removing just revert to `session[:search_type]`
default = session[:search_type]&.to_s&.pluralize&.to_sym || :observations
help_controller = [:names, :observations].include?(default) ? default : nil
search_options = options_for_select(search_type_options, default)
identify_page = controller.controller_name == "identify"
form_group_class = class_names(
  %w[form-group has-feedback has-search d-flex flex-grow-1 mb-0]
)
# Fields have attributes nested under search via fields_for, eg search[:type]
%>

<% if @user %>
  <%= tag.div(class: "navbar-flex w-100 gap-2") do %>

    <%= tag.button(
      link_icon(:info, title: :search_bar_help.t),
      class: class_names("btn btn-link navbar-link px-2"), type: :button,
      data: { toggle: "collapse", target: "#search_nav_help" },
      aria: { expanded: "false", controls: "search_nav_help" }
    ) %>

    <%= form_with(url: search_pattern_path, method: :get,
                  class: "navbar-flex flex-grow-1 navbar-form px-0 gap-2",
                  id: "pattern_search_form") do |f| %>

      <%= fields_for(:pattern_search) do |f_s| %>
        <%= tag.div(class: form_group_class) do %>
          <%= link_icon(:search, class: "form-control-feedback hidden-xs") %>
          <%= f_s.text_field(
                :pattern,
                value: session[:pattern],
                class: "form-control flex-grow-1",
                placeholder: :app_find.t
              ) %>
        <% end %><!--.form-group-->

        <%= tag.div(class: "form-group text-nowrap mb-0") do %>
          <%= f_s.select(
                :type, search_options, { },
                { class: "form-control",
                  data: { search_type_target: "select",
                          action: "search-type#getHelp" } }
              ) %>
        <% end %><!--.form-group-->
      <% end %>

      <%= hidden_field_tag(:needs_naming, true) if identify_page %>

      <%= tag.div(class: "form-group text-nowrap") do %>
        <%= tag.button(type: :submit,
                       class: "btn btn-outline-default px-2") do
          [
            tag.span(link_icon(:search), class: "d-sm-none"),
            tag.span(:app_search.l, class: "hidden-xs")
          ].safe_join
        end %>
      <% end %><!--.form-group-->

    <% end %>

    <%= icon_link_to(
      :app_advanced_search.l, search_advanced_path,
      icon: :plus, class: "btn navbar-link px-0", show_text: false
    ) %>

  <% end %>

  <%= tag.div(class: "collapse w-100", id: "search_nav_help",
              data: { search_type_target: "help" }) do %>
    <%= render(partial: "#{help_controller}/search/help") if help_controller %>
  <% end %>
<% else %>

  <strong class="navbar-text mx-2 text-nowrap">
    <%= :app_login_reminder.t %>:
  </strong>

<% end %>
