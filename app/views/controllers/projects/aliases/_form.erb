<%#
  This form swaps between location and user autocompleter types.
  Both target namespaces are needed so either controller can find elements.
  Both actions are needed so swapping works in either direction.
%>
<%
  if local_assigns[:form_locals]
    project_alias = form_locals[:project_alias]
  end
  container_class(:text)
  type = (project_alias.target_type || :location).downcase.to_sym
  value = project_alias.target&.format_name || ""
  initial_controller = "autocompleter--#{type}"
  form_args = { model: project_alias,
                data: { controller: initial_controller, type: } }
  if local_assigns[:local] == true
    form_args = form_args.merge({ local: true })
  else
    form_args = form_args.deep_merge({ data: { turbo: true } })
  end
%>

<%= form_with(**form_args) do |form| %>

  <% if project_alias.errors.any? %>
    <% count = pluralize(project_alias.errors.count, "error") %>
    <%= render(
      Components::Alert.new(level: :danger, id: "error_explanation")
    ) do
      [
        tag.h2("#{count} prohibited this project alias from being saved:"),
        tag.ul do
          project_alias.errors.full_messages.each do |message|
            concat(tag.li(message))
          end
        end
      ].safe_join
    end %>
  <% end %>

  <%= text_field_with_label(
    form:, field: :name, label: "#{:Name.t}:", inline: true
  ) %>
  <%= form.hidden_field(:project_id, value: project_alias.project_id) %>

  <%= tag.div(class: "form-group dropdown",
              data: {
                autocompleter__location_target: "wrap",
                autocompleter__user_target: "wrap"
              }) do %>
    <%= select_with_label(form:,
                          field: :target_type,
                          label: "#{:project_alias_type.t}:",
                          options: [[:USER.l, :user], [:LOCATION.l, :location]],
                          inline: true,
                          selected: type,
                          data: {
                            autocompleter__location_target: "select",
                            autocompleter__user_target: "select",
                            action: "autocompleter--location#swap " \
                                    "autocompleter--user#swap"
                          }) %>

    <%= form.hidden_field(:target_id, value: project_alias.target_id,
          data: {
            autocompleter__location_target: "hidden",
            autocompleter__user_target: "hidden"
          }) %>
    <%= form.text_field(:term, value:, class: "form-control",
          data: {
            autocompleter__location_target: "input",
            autocompleter__user_target: "input"
          }) %>
    <%# Dropdown with both namespaces %>
    <%= tag.div(class: "auto_complete dropdown-menu", data: {
          autocompleter__location_target: "pulldown",
          autocompleter__user_target: "pulldown",
          action: "scroll->autocompleter--location#scrollList:passive " \
                  "scroll->autocompleter--user#scrollList:passive"
        }) do %>
      <%= tag.ul(class: "virtual_list", data: {
            autocompleter__location_target: "list",
            autocompleter__user_target: "list"
          }) do %>
        <% 10.times do |i| %>
          <%= tag.li(class: "dropdown-item") do %>
            <%= link_to("", "#", data: { row: i,
                  action: "click->autocompleter--location#selectRow:prevent " \
                          "click->autocompleter--user#selectRow:prevent"
                }) %>
          <% end %>
        <% end %>
      <% end %>
    <% end %>
  <% end %>

  <%= submit_button(form:, button: form_submit_text(@project_alias), class: "mb-5") %>
<% end %>
