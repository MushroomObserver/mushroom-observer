<%# locals: (action:) -%>
<%
create = (action == :create)
method = create ? :post : :patch
button_name = create ? :CREATE.l : :SAVE_EDITS.l
include_naming = create ? true : false
has_specimen = create ? false : @observation.herbarium_records.length > 0
logging_optional = create ? false : true

# Data for the form-images Stimulus controller.
# Controller element is the form, so image dropzone can cover the whole form.
max_size = MO.image_upload_max_size
legible_max_size = (max_size.to_f/1024/1024).round
image_upload_localization = {
  uploading_text: :form_observations_uploading_images.t,
  image_too_big_text: :form_observations_image_too_big.t(max: legible_max_size),
  creating_observation_text: :form_observations_creating_observation.t,
  months: :all_months.t,
  show_on_map: :show_on_map.t,
  something_went_wrong: :form_observations_upload_error.t
}.to_json
data = {
  controller: "form-images form-exif map",
  action: [
    "map:reenableBtns@window->form-exif#reenableButtons",
    "form-exif:pointChanged@window->map#calculateMarker",
    "autocompleter:hiddenIdDataChanged@window->map#showBox",
  ].join(" "),
  upload_max_size: max_size,
  localization: image_upload_localization,
  form_images_target: "form",
  exif_used: create ? false : true
}
%>

<%= form_with(
  model: @observation,
  url: add_query_param(action:, id: @observation,
                       approved_name: @given_name,
                       approved_where: @place_name),
  method:,
  multipart: true,
  id: "observation_form",
  data:
) do |f| %>

  <%= if @field_code
    tag.p("#{:form_observations_field_code.t} #{@field_code}")
  end %>
  <%= hidden_field_tag(:field_code, @field_code) %>

  <% ########################### Image Forms ############################## %>

  <%= render(partial: "observations/form/images", locals: { f: f }) %>

  <% ############################# Details ################################ %>

  <%= render(partial: "observations/form/details",
             locals: { f:, button_name:, location: @location }) %>

  <% ########################## Identification ############################ %>

  <%= render(partial: "observations/form/identification",
             locals: { f:, action:, button_name:, include_naming: }) %>

  <% ####################################################################### %>

  <% if @projects.any? || @lists.any? %>
    <%= render(partial: "observations/form/projects_and_lists",
               locals: { f:, button_name: }) %>
  <% end %>

  <% if logging_optional %>
    <%= check_box_with_label(form: f, field: :log_change, checked: "checked",
                             label: :form_observations_log_change.t) %>
  <% end %>

<% end %><!--[/form:observation]-->
