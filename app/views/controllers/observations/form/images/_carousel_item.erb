<%=
# Incoming locals: img_number, img_file_name, img_file_size,
#                  f, active, image, upload, img_src
# upload == no image.id, image == nil, image_src == nil
image ||= nil
img_number ||= "img_number_missing"
img_id = image&.id || img_number # in case good_image
img_src = upload ? "" : image&.large_url
handle = upload ? "added_image_wrapper" : ""
item_attrs = { id: "carousel_item_#{img_id}",
               class: class_names("item", active, handle) }
data = { obs_form_images_target: "item" }
data = data.merge(image_number: img_number) if upload
data = data.merge(good_image: true) unless upload
item_attrs = item_attrs.merge(data: data)
exif_data = image&.read_exif_geocode || {}

tag.div(**item_attrs) do
  tag.div(class: "row") do
    concat(tag.div(class: "image-position col-12 col-md-6") do
      concat(image_tag(
        img_src,
        class: "carousel-image img-fluid ab-fab object-fit-contain lazy",
        data: { src: img_src }
      ))
      concat(tag.div(class: "ab-fab ml-4 mt-4") do
        carousel_set_thumb_img(image:, active:)
      end)
    end)
    concat(tag.div(class: "form-position col-12 col-md-6") do
      tag.div(class: "form-panel") do
        if upload
          render(partial: "observations/form/images/fields_for_upload",
                 locals: { img_number:, img_file_name:, img_file_size: })
        else
          render(partial: "observations/form/images/fields_for_edit",
                 locals: { f:, image:, exif_data: })
        end
      end
    end)
  end
end
%>
