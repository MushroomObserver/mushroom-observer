<%# When and Where (location) section of create_observation form
    including location autocomplete, map, lat/long/alt %>

<%= panel_block(id: "observation_details",
                heading: :show_observation_details.l) do %>

  <div class="row mt-3">
    <div class="col-xs-12 col-sm-6">

      <!-- WHEN -->
      <%= date_select_with_label(
        form: f, field: :when, object: @observation, label: :WHEN.t + ":",
      ) %>
      <!-- /WHEN -->

      <%= tag.div(id: "observation_where") do %>
        <%= label_tag(:where, "#{:WHERE_GROUP.l}:") %>
        <!-- LAT_LONG_ALT -->
        <div class="row no-gutters" id="observation_lat_lng_alt">
          <div class="col-xs-4">
            <%= text_field_with_label(
              form: f, field: :lat, label: :LATITUDE.t + ":", class: "mb-0",
              between: collapse_info_trigger("geolocation_help"),
              data: { map_target: "latInput", action: "map#bufferInputs" }
            ) %>
          </div>
          <div class="col-xs-4">
            <%= text_field_with_label(
              form: f, field: :lng, label: :LONGITUDE.t + ":", class: "mb-0",
              data: { map_target: "lngInput", action: "map#bufferInputs" }
            ) %>
          </div>
          <div class="col-xs-4">
            <%= text_field_with_label(
              form: f, field: :alt, label: :ALTITUDE.t + ":", class: "mb-0",
              addon: "m", # (#{:units_meters.t})
              data: { map_target: "altInput" }
            ) %>
          </div>
        </div><!--.row-->

        <%= collapse_help_block(nil, id: "geolocation_help") do %>
          <%= :form_observations_lat_long_help.t %>
        <% end %>

        <%= check_box_with_label(form: f, field: :gps_hidden,
                                label: :form_observations_gps_hidden.t) %>
        <!-- /LAT_LONG_ALT -->

        <!-- WHERE_REASONS -->
        <%= render(partial: "shared/form_location_feedback",
                   locals: { button: button_name } ) %>
        <!-- /WHERE_REASONS -->

        <%# NOTE: Both map & form-exif controllers dispatch pointChanged event.
            map:pointChanged event == form-exif:pointChanged event
            detail: { type, request_params: { lat, lng } }
        For now we have to duplicate the code. When form-exif updates
        the lat/lng inputs it's not enough to be caught by map, because
        the inputs are buffered. map only fires the event after buffering. %>
        <!-- WHERE -->
        <%= autocompleter_field(
          form: f, field: :place_name, type: :location,
          label: [tag.span("#{:WHERE.l}:", class: "unconstrained-label"),
                  tag.span("#{:form_observations_locality_contains.l}:",
                           class: "constrained-label")].safe_join(" "),
          between: collapse_info_trigger("where_help"),
          hidden: location&.id,
          hidden_data: { map_target: "locationId",
                         north: location&.north, south: location&.south,
                         east: location&.east, west: location&.west },
          data: { map_target: "placeInput",
                  action: [
                    "map:pointChanged@window->autocompleter#swap",
                    "form-exif:pointChanged@window->autocompleter#swap"
                  ].join(" ") }
        ) %>
        <%= collapse_help_block(nil, id: "where_help") do
          observation_location_help
        end %>
        <!-- /WHERE -->

        <!-- IS_COLLECTION_LOCATION -->
        <%= check_box_with_label(
              form: f, field: :is_collection_location,
              label: :form_observations_is_collection_location.t,
              append: collapse_info_trigger("is_collection_location_help",
                                            class: "ml-3")
            ) %>
        <%= collapse_help_block(nil, id: "is_collection_location_help") do %>
          <%= :form_observations_is_collection_location_help.t %>
        <% end %>
        <!-- /IS_COLLECTION_LOCATION -->
      <% end %>
    </div><!--.col-->

    <!-- MAP -->
    <div class="col-xs-12 col-sm-6" id="observation_geolocation">
      <%# tag.label("#{:form_observations_click_on_map.l}:") %>
      <%= tag.div do %>
        <%= js_button(
          button: [link_icon(:globe),
                   :form_observations_open_map.t].safe_join(" "),
          name: "map_open", class: "map-open",
          data: { map_target: "openMapBtn", action: "map#openMap" }
        ) %>
        <%= js_button(
          button: :form_observations_show_point.t,
          name: "show_point", class: "show-point",
          data: { map_target: "showPointBtn", action: "map#showMarker" }
        ) %>
        <%= js_button(
          button: :form_observations_locate_on_map.t,
          name: "locate_on_map", class: "map-locate my-3",
          data: { map_target: "showBoxBtn", action: "map#showBox" }
        ) %>
        <%= js_button(
          button: :form_observations_clear_map.t,
          name: "map_clear", class: "map-clear",
          data: { map_target: "mapClearBtn",
                  action: "map#clearMap form-exif#reenableButtons" }
        ) %>
      <% end %>
      <%= tag.div(
        "", id: "observation_form_map",
            class: "observation-form-map d-none",
            data: { indicator_url: asset_path('indicator.gif'),
                    location_format: User.current_location_format,
                    map_target: "mapDiv", editable: true,
                    map_type: "observation" }
      ) %>
    </div>
    <!-- /MAP -->

  </div><!--.row-->

<% end %>
