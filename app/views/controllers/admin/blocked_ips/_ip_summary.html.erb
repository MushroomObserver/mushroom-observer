<%= render(Components::Panel.new(panel_class: "my-3", panel_id: "ip_summary")) do |panel| %>
  <% panel.with_heading do %>
    Most active users: (top 50)
  <% end %>
  <% panel.with_body do %>
    <%
      sorted_ips = @stats.keys.sort_by { |ip| @stats[ip][:load] }.reverse[0..50]
    %>
    <%= render(Components::Table.new(sorted_ips,
                                     class: "ips ips-lined")) do |t| %>
      <% t.column("ip") do |ip| %>
        <%= link_to(ip, edit_admin_blocked_ips_path(report: ip)) %>
      <% end %>
      <% t.column("block") do |ip| %>
        <% unless IpStats.blocked?(ip) %>
          <%= patch_button(name: "Block",
                           path: admin_blocked_ips_path(add_bad: ip),
                           class: "btn btn-default") %>
        <% end %>
      <% end %>
      <% t.column("user") do |ip| %>
        <% if (user_id = @stats[ip][:user]) %>
          User: <%= user_link(User.safe_find(user_id) || user_id) %><br/>
        <% elsif browser.bot? %>
          bot<br/>
        <% end %>
        <% if (api_key_str = @stats[ip][:api_key]) %>
          <% api_key = APIKey.find_by_key(api_key_str) %>
          API key: <%= api_key_str %>
          (<%= api_key ? user_link(api_key.user) : "bogus!" %>)<br/>
        <% end %>
      <% end %>
      <% t.column("rate / min") do |ip| %>
        <%= (@stats[ip][:rate] * 60).round(2) %>
      <% end %>
      <% t.column("load %") do |ip| %>
        <%= (@stats[ip][:load] * 100).round(2) %>
      <% end %>
    <% end %>
  <% end %>
<% end %>
