#!/usr/bin/env ruby
# frozen_string_literal: true

# Creates a spreadsheet with only catalogNumber and imageUrls
# from a full Mycoportal "report"
#
# Sample usage
# In the app, download Observations from, e.g., Search results
# Download Observation Data using the MyCoPortal option,
# saving the report in the tmp directory, e.g., tmp/observations_235im.tsv
# Run this script with the saved report as the argument, e.g.:
#  mushroom-observer % script/mycoportal_images_only tmp/observations_253im.tsv

require "csv"
require "fileutils"

# Copy the full TSV file
src = ARGV[0]
dest = ARGV[1] || src.sub(/(\.tsv)?$/, "_images.tsv")
FileUtils.cp(src, dest)

# Load the copied file
rows = CSV.read(dest, col_sep: "\t", headers: true)

# Remove all columns except catalogNumber and imagesUrl
filtered_headers = %w[catalogNumber imageUrls]
filtered_rows = rows.map do |row|
  [row["catalogNumber"], row["imageUrls"]]
end

# Save the file (overwrite dest)
CSV.open(dest, "w", col_sep: "\t") do |csv|
  csv << filtered_headers
  filtered_rows.each { |row| csv << row }
end

puts "Filtered file saved to #{dest}"
